\chapter{提案手法：化合物の部分構造を利用したフィルタリング（プレドッキング）手法の開発}
ここでは本研究で新たに提案する，化合物を部分構造に分割することで
高速にドッキングを完了させるフィルタリング（プレドッキング）手法の内容を記述する．

\section{提案手法の概説}
前章で述べた通りドッキングシミュレーションは多くの計算時間を要するが，その理由は探索空間の広さと
ドッキング計算を行うべき化合物の数の多さにある．この節では，この2つの問題を解決するアイデア，および高速に
フィルタリングを行うために追加する仮定を説明する．

\subsection{フィルタリングの要件}\label{subsec}
フィルタリングに求められる要件は2つ存在する．
\begin{enumerate}
\item 高速に化合物を評価すること\\
	フィルタリングを実用的に行うためには，フィルタリング後に行うドッキングシミュレーションよりも十分に高速である必要がある．
\item 予測の精度がある程度保持されていること\\
	一般に計算速度と予測精度はトレードオフの関係にあるが，どれほど高速であってもある程度予測精度が保持されていること，
	特に偽陰性（False Negative）を出さないように弁別することがフィルタリングには求められる．
\end{enumerate}
一方，フィルタリングはその後に複合体構造を予測する通常のドッキングシミュレーションを行うことを前提とするため，
必ずしもタンパク質と化合物との複合体構造を出力する必要はなく，
偽陽性（False Positive）を発生させることもある程度は許容される．

\subsection{提案手法へのアイデア}\label{subsec:idea}
前節で示したフィルタリングの要件を満たすために，2つのアイデアを考案した．

\begin{enumerate}
\item \b{化合物を部分構造に分割し，部分構造のドッキングシミュレーションを行う}\\
\ref{subsec:docking_elements}節で述べたように，化合物の内部自由度が及ぼす計算量への影響は大きい．
そのため，eHiTS\cite{Zsoldos2007}やFlexX\cite{Rarey1996}など一部のドッキングシミュレーションツールでは
化合物を内部自由度のより少ない部分構造に分割し，タンパク質と部分構造との結合能力を評価しつつ
最終的な複合体構造を構成する，という手法を用いている．
本提案手法では，小峰ら\cite{Shunta2015}による化合物の分割方法を用いて化合物を内部自由度を考慮しなくて良い
「フラグメント」に分割，これらをドッキングすることで必要最低限の探索空間でのドッキングシミュレーションを実現する．

\item \b{フラグメントから化合物の構造を再構成せず，フラグメントの結合スコアから化合物のフィルタリングスコアを算出する}\\
構造分割に基づくドッキングシミュレーションツールでは，対象の化合物の内部構造に衝突などの問題が発生しないように部分構造を
相互配置してタンパク質と化合物との複合体構造を形成する．しかし部分構造同士の衝突などの考慮を行うと，単純なアルゴリズムでは
計算量が化合物を構成する部分構造数の指数オーダーとなってしまい，近似アルゴリズムを用いたとしても時間を要してしまう．
\end{enumerate}

一方，本研究で提案するプレドッキング手法は，その後に複合体構造を予測するドッキングシミュレーションを行うことを前提とするため
タンパク質と化合物との正しい複合体構造を必ずしも出力する必要はない．
そこで提案手法ではフラグメントに分割する前の化合物の構造に関する考慮を行わないアプローチを選択した．
こうすることで，図\ref{fig:divided_fragment}のようにフラグメント同士の衝突が許容されてしまうが，
化合物のスコアをフラグメント数の線形オーダー$O(n)$で算出することが可能になり，高速な化合物の評価ができるようになる．

\begin{figure}[t]
 \begin{center}
  \fig[width=0.6\hsize]{./fig/method/fragments_aa2ar.png}
  \caption{フラグメント単位でのドッキング結果例}
  \label{fig:divided_fragment}
 \end{center}
\end{figure}



\section{提案手法の詳細の説明}
前節で本研究で用いる2つのアイデアを示したが，それを用いてどのようにフィルタリングを実現しているのかをこの節で詳説する．

\subsection{提案手法のフローチャート}\label{subsec:flowchart}
提案手法は以下の手順で構成される．
\begin{enumerate}
\item 入力化合物群をフラグメントに分割する
\item ドッキングシミュレーションツールを用いて各フラグメントの標的タンパク質への結合スコアを算出する
\item 各フラグメントの結合スコアから化合物全体としてのフィルタリングスコアを算出する
\item フィルタリングスコアの上位N\%をフィルタを通過した化合物として出力する
\end{enumerate}
ワークフローを図\ref{fig:workflow}に示す．

\begin{figure}[p]
 \begin{center}
  \fig[width=0.6\hsize]{./fig/method/proposal_workflow.eps}
  \caption{提案手法の手順}
  \label{fig:workflow}
 \end{center}
\end{figure}

\subsection{化合物のフラグメントへの分割}\label{subsec:decomposition}
化合物の分割は小峰らによる手法\cite{Shunta2015}を用い，内部自由度を持たない部分構造であるフラグメントを生成する．
実装にはC++を用い，ケモインフォマティクスツールであるOpenBabel\cite{OBoyle2011}およびOpenMP，Boostを利用している．
フラグメント分割のアルゴリズムを以下に示し，このアルゴリズムによるフラグメント分割の進行を図\ref{fig:decomposition}に示す．
\begin{enumerate} 
\item 元の分子のうち，重原子（水素以外の原子）のみに着目し，原子一つひとつを初期フラグメントとする．
	（図\ref{fig:decomposition} 左から2番目）
\item 回転可能な単結合以外の結合の両端の2原子を同一フラグメントとする．
\item 環構造を構成している原子を同一フラグメントとする．（図\ref{fig:decomposition} 左から3番目）
\item 回転可能な単結合を構成する原子ペアのうち，片方にそれ以上原子がつながっていない場合には同一フラグメントとする．
	これは，片方にそれ以上の原子がつながっていない場合，回転可能な単結合を回転させてもその原子がその場で回転するだけとなり，
	化合物の原子の位置関係には影響を与えないためである．
\item 2つの単結合の切断により孤立してしまう原子は，切断された先に存在する2つのフラグメントのどちらかに併合する．
	なお，3つ以上の単結合の切断により孤立してしまう原子に関してはこの操作を行わない．（図\ref{fig:decomposition} 左から4番目）
\item 全ての水素原子について，その原子が結合している重原子の属するフラグメントに含める．
\item 切断面に水素原子を付加する．
\end{enumerate}
\begin{figure}[htp]
 \begin{center}
  \fig[width=0.99\hsize]{./fig/method/decomposition.png}
  \caption{化合物のフラグメント分割アルゴリズム\cite{Shunta2015}}
  \label{fig:decomposition}
 \end{center}
\end{figure}
この化合物のフラグメントへの分割により，内部自由度を考慮することなくドッキングシミュレーションを行うことができる．

また，複数の化合物間で部分構造に共通性が見られることが非常に多く，本研究で用いている分割手法によって得られるものの中にも
多数の共通フラグメントが発生する．例えば，ZINCの``drugs now''データセットに含まれている10,639,555化合物を順次フラグメント分割した
場合のフラグメントの種類数をプロットすると，図\ref{fig:decomposition_amount}のようになり，わずか20万フラグメントによって1,000万化合物が
構成されていることが分かる．
\begin{figure}[htp]
 \begin{center}
  \fig[width=0.6\hsize]{./fig/method/decomposition_zinc.eps}
  \caption{ZINC ``drugs now'' 10,639,555化合物を分割した例}
  \label{fig:decomposition_amount}
 \end{center}
\end{figure}
このフラグメント種類数の増加は化合物数の増加に比べて緩やかであり，\b{化合物数が多ければ多いほど
フラグメント分割による速度への貢献が大きい}と考えられる．

\subsection{フラグメント単位でのドッキングシミュレーション}
次に，分割されたフラグメントについて，標的タンパク質との結合スコアを求めるためにドッキングシミュレーションを行う．
本研究では，有償ソフトであるGlide\cite{Friesner2004}を用いる．Glideには
\begin{itemize}
\item 高速（HTVS）モード
\item 通常（SP）モード
\item 精密（XP）モード
\end{itemize}
の3種類のモードが存在するが，本研究ではHTVSモードとSPモードを利用した場合の評価を行う．
%SPモードはデフォルト設定では内部自由度を考慮したドッキングを行ってしまうため，内部自由度を無視するオプションを追加している．
また，一般的に1つのタンパク質と1つの化合物とのドッキング結果では複数のタンパク質-フラグメント結合予測構造および
結合スコアが出力されるが，この後の化合物のフィルタリングスコアの算出ではこのうち最良の結合スコアを利用する
（図\ref{fig:fragment_result}）．

\begin{figure}[t]
\begin{minipage}{0.5\hsize}
 \begin{center}
  \fig[width=0.9\hsize]{./fig/method/score_1.png}
 \end{center}
\end{minipage}
\begin{minipage}{0.5\hsize}
 \begin{center}
  \fig[width=0.9\hsize]{./fig/method/score_2.png}
 \end{center}
\end{minipage}
 \caption{複数のドッキング結果の出力例および最良構造の選択}
 \label{fig:fragment_result}
\end{figure}

\newpage

\subsection{化合物のフィルタリングスコアの算出}
フラグメント単位でのドッキングシミュレーションによって，フラグメントの結合構造およびその結合スコアを得た．
続いて，このフラグメント結合スコアから化合物のフィルタリングに用いるスコアを算出する．
本研究では，3種類のスコアの算出方法の実験を行った．

\begin{enumerate}
\item \b{総和法（score\_sum）}\\
各フラグメント結合スコアの総和をとり，それを化合物全体のフィルタリングスコアとする．
全てのフラグメントが高いスコアでタンパク質と結合できる化合物の評価を高くする手法である．
フラグメント群は化合物に存在する結合という束縛条件を一部緩和したものであるため，一般にこの手法によって得られた
化合物フィルタリングスコアは化合物そのものの結合スコアよりも高くなり，特に分割数が多ければ多いほどこの傾向は顕著になる．
このため，重原子（水素以外の原子）の数が2個以下の小さなフラグメントの結合スコアはフィルタリングスコア算出から除外することで
フィルタリングスコアの無意味な向上を抑えている（図\ref{fig:scoring}）．
\begin{eqnarray}
SCORE_{化合物}=\sum_{\shortstack{\tiny $重原子数>2$の\\ \tiny フラグメント}} SCORE_{フラグメント}
\end{eqnarray}

\item \b{最良値法（score\_max）}\\
各フラグメント結合スコアのうちの最良値をとり，それを化合物全体のフィルタリングスコアとする（図\ref{fig:scoring}）．
1つでもタンパク質との結合スコアが非常に良いフラグメントを持っている化合物の評価が高くなる手法である．
%フラグメント1つの結合スコアが化合物のフィルタリングスコアとなること，ドッキングシミュレーションを行う分子のサイズと
%結合スコアには正の相関がある\cite{Verdonk2004}ことから，
総和法とは異なりこの手法によって得られた化合物フィルタリングスコアは化合物そのものの結合スコアよりも低くなる．
\begin{eqnarray}
SCORE_{化合物}=\max_{\shortstack{\tiny すべての\\ \tiny フラグメント}} SCORE_{フラグメント}
\end{eqnarray}

\item \b{総和法と最良値法の値の線形和（maxsumBS）}\\
これまでに示した総和法と最良値法はフラグメント結合スコアの全て，もしくはただ1つを見る手法であり両極端であるため，
これらを統合して用いることで，より良い指標となるのではないかと考えた．
しかし，総和法の値域が最良値法の値域よりも大きいために単純和では総和法の影響を大きく受けてしまう．
そこで，2つの手法を適当なバランスで組み合わせるために，フィルタリングを行いたい化合物群の総和法によるスコア，最良値法によるスコアを
それぞれ平均0，分散1にし（すなわちzスコア化し），変換後のスコアを足し合わせることでバランスよくスコアを統合する（図\ref{fig:maxsumBS}）．この手法は総和法によるスコアと最良値法によるスコアのバランスをとったスコアであるので，maxsumBS（max-sum Balanced Score）として以下では記述する．
\end{enumerate}

\begin{figure}[h]
 \begin{center}
  \fig[width=0.99\hsize]{./fig/method/scoring.pdf}
  \caption{score\_sum, score\_maxの算出}
  \label{fig:scoring}
 \end{center}
\end{figure}

\begin{figure}[hb]
 \begin{center}
  \fig[width=0.99\hsize]{./fig/method/maxsumBS.eps}
  \caption{maxsumBSの算出}
  \label{fig:maxsumBS}
 \end{center}
\end{figure}