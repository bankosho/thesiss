\chapter{提案手法：化合物の部分構造を利用したフィルタリング手法の開発}
ここでは、従来手法であるGlide HTVSとは異なり、化合物を部分構造に分割することで高速にドッキングを完了させるフィルタリング手法の内容を説明する。

\section{提案手法の概説}
前章で述べた通りドッキングシミュレーションは時間を要するが、その理由は探索空間の広さと化合物の多様性にある。
この節では、この2つの問題を解決するアイデア、および高速にフィルタリングを行うために追加する仮定を説明する。

\subsection{フィルタリングの要件}\label{subsec}
フィルタリングに求められる要件は2つ存在する。
\begin{itemize}
\item 高速に化合物を評価する\\
	フィルタリングを実用的に行うためには、フィルタリング後に行うドッキングシミュレーションよりも十分に高速である必要がある。
\item 予測の精度がある程度保持されている\\
	一般に計算速度と予測精度はトレードオフの関係にあるが、どれほど高速であってもある程度正例と負例が弁別できなければ
	フィルタリングとして機能しない。したがって、予測精度がある程度保持されていることもフィルタリングには求められる。
\end{itemize}
一方、フィルタリングはその後に通常のドッキングシミュレーションを行うことを前提とするため、
必ずしも「化合物がタンパク質のこの部分に結合する」というドッキングポーズを出力する必要はない。

\subsection{提案手法へのアイデア}\label{subsec:idea}
前節で示したフィルタリングの要件を満たすために、2つのアイデアを考案した。

\subsubsection{化合物を部分構造に分割し、部分構造のドッキングシミュレーションを行う}
\ref{subsec:docking_elements}節で述べたように、化合物の内部自由度が及ぼす計算量への影響は大きい。
そこで、本提案手法では、小峰ら\cite{Shunta2015}による化合物の分割方法を用いて、化合物を内部自由度を考慮しなくて良い
「フラグメント」に分割、これらをドッキングすることで、必要最低限の探索空間でのドッキングシミュレーションを実現する。

\subsubsection{フラグメントから化合物の構造を再構成せず、フラグメントの結合スコアから化合物のフィルタリングスコアを算出する}
化合物をフラグメントに分割した上でドッキングシミュレーションを行うと図\ref{fig:divided_fragment}のように
フラグメントごとにタンパク質との結合予測構造が出力され、フラグメントの結合スコアが最も良いポーズを選択したとしても
繋がった一つの化合物としては有り得ない構造をとる場合がほとんどである。
\begin{figure}[t]
 \begin{center}
  \fig[width=0.6\hsize]{./fig/method/fragments_aa2ar.png}
  \caption{フラグメント単位でのドッキング結果例}
  \label{fig:divided_fragment}
 \end{center}
\end{figure}
しかし、矛盾のない化合物の構造をとるようなフラグメントの選択を行うのは$O(a^n) (nは化合物を構成するフラグメント数)$の計算量となり、
大きな計算コストを要してしまう。

一方、フィルタリングはその後に通常のドッキングシミュレーションを行うことを前提とするため、
必ずしも化合物とタンパク質との結合予測構造を出力する必要はない。
そこで、提案手法では構造の矛盾の考慮を行わず、得られたフラグメントの結合スコアのみに着目し、
フラグメントの結合スコアから化合物のフィルタリングスコアを算出するのに計算が$O(n)$で済むようなスコアの統合を行うことで、
高速な化合物の評価を達成する。

\section{提案手法の詳細の説明}
前節で用いる2つのアイデアを示したが、それを用いてどのようにフィルタリングを実現しているのかをこの節で詳説する。

\subsection{提案手法のフローチャート}\label{subsec:flowchart}
提案手法は以下の手順で構成される。
\begin{enumerate}
\item 入力された化合物をフラグメントに分割する
\item ドッキングシミュレーションツールを用いてフラグメントの標的タンパク質への結合スコアを算出する
\item フラグメントの結合スコアから化合物のフィルタリングスコアを算出する
\item フィルタリングスコアの上位N\%をフィルタを通過した化合物として出力する
\end{enumerate}
ワークフローを図\ref{fig:workflow}に示す。

\begin{figure}[p]
 \begin{center}
  \fig[width=0.6\hsize]{./fig/method/proposal_workflow.eps}
  \caption{提案手法の手順}
  \label{fig:workflow}
 \end{center}
\end{figure}

\subsection{化合物のフラグメントへの分割}\label{subsec:decomposition}
化合物の分割は小峰らによる手法\cite{Shunta2015}を用い、内部自由度を持たない部分構造であるフラグメントを生成する。
実装にはC++を用い、ケモインフォマティクスツールであるOpenBabel\cite{OBoyle2011}およびOpenMP、Boostを利用している。
フラグメント分割のアルゴリズムを以下に示し、このアルゴリズムによるフラグメント分割の進行を図\ref{fig:decomposition}に示す。
\begin{enumerate} 
\item 元の分子のうち、重原子（水素以外の原子）のみに着目し、原子一つひとつをフラグメントとする。（図\ref{fig:decomposition} 左から２番目）
\item 回転可能な単結合以外の結合の両端の２原子を同一フラグメントとする。
\item 環構造を構成している原子を同一フラグメントとする。（図\ref{fig:decomposition} 左から３番目）
\item 回転可能な単結合を構成する原子ペアのうち、片方にそれ以上原子がつながっていない場合には同一フラグメントとする。
	これは、片方にそれ以上の原子がつながっていない場合、回転可能な単結合を回転させてもその原子がその場で回転するだけとなり、
	化合物の原子の位置関係には影響を与えないためである。
\item ２つの単結合の切断により孤立してしまう原子は、切断された先に存在する２つのフラグメントのどちらかに併合する。
	なお、３つ以上の単結合の切断により孤立してしまう原子に関してはこの操作を行わない。（図\ref{fig:decomposition} 左から４番目）
\item 全ての水素原子について、その原子が結合している重原子の属するフラグメントに含める。
\item 切断面に水素原子を付加する。
\end{enumerate}
\begin{figure}[htp]
 \begin{center}
  \fig[width=0.99\hsize]{./fig/method/decomposition.png}
  \caption{化合物のフラグメント分割アルゴリズム\cite{Shunta2015}}
  \label{fig:decomposition}
 \end{center}
\end{figure}
この化合物のフラグメントへの分割により、内部自由度を考慮することなくドッキングシミュレーションを行うことができる。

また、複数の化合物間で部分構造に共通性が見られることが非常に多く、本研究で用いている分割手法によって得られるものの中にも
多数の共通フラグメントが発生する。例えば、ZINCの"drugs now"データセットに含まれている10,639,555化合物を順次フラグメント分割した
場合のフラグメントの種類数をプロットすると、図\ref{fig:decomposition_amount}のようになり、わずか20万フラグメントによって1,000万化合物が
構成されていることが分かる。
\begin{figure}[htp]
 \begin{center}
  \fig[width=0.6\hsize]{./fig/method/decomposition_zinc.eps}
  \caption{ZINC "drugs now" 10,639,555化合物を分割した例}
  \label{fig:decomposition_amount}
 \end{center}
\end{figure}
このフラグメント種類数の増加は化合物数の増加に比べて緩やかであり、化合物数が多ければ多いほど
フラグメント分割による速度への貢献が大きいと考えられる。

\subsection{フラグメント単位でのドッキングシミュレーション}
次に、分割されたフラグメントについて、標的タンパク質との結合スコアを求めるためにドッキングシミュレーションを行う。
本研究では、有償ソフトであるglide\cite{Friesner2004}を用いる。glideには高速（HTVS）モード、通常（SP）モード、精密（XP）モードの
3種類のモードが存在するが、本研究ではSPモードとHTVSモードを利用した場合の評価を行う。
SPモードはデフォルト設定では内部自由度を考慮したドッキングを行ってしまうため、内部自由度を無視するオプションを追加している。
また、一般的に１つのタンパク質と１つの化合物とのドッキング結果では複数のタンパク質-フラグメント結合予測構造および
結合スコアが出力されるが、この後の化合物のフィルタリングスコアの算出ではこのうち最良の結合スコアを利用する
（図\ref{fig:fragment_result1}, \ref{fig:fragment_result2}）。

\begin{figure}[bt]
\begin{minipage}{0.5\hsize}
 \begin{center}
  \fig[width=0.9\hsize]{./fig/method/score_1.png}
  \caption{複数のドッキング結果の出力例}
  \label{fig:fragment_result1}
 \end{center}
\end{minipage}
\begin{minipage}{0.5\hsize}
 \begin{center}
  \fig[width=0.9\hsize]{./fig/method/score_2.png}
  \caption{最良のドッキング結果のみを利用}
  \label{fig:fragment_result2}
 \end{center}
\end{minipage}
\end{figure}

\subsection{化合物のフィルタリングスコアの算出}
フラグメント単位でのドッキングシミュレーションによって、フラグメントの結合構造およびその結合スコアを得た。
続いて、このフラグメント結合スコアから化合物のフィルタリングに用いるスコアを算出する。
本研究では、3種類のスコアの算出方法の実験を行った。

\subsubsection{総和法（score\_sum）}
フラグメント結合スコアの総和をとり、それを化合物のフィルタリングスコアとする。
構成する全てのフラグメントがタンパク質と良い結合構造を取れるような化合物を薬物候補化合物として適しているとして評価を高くする手法
である。フラグメント群は化合物に存在する結合という束縛条件を一部緩和したものであるため、一般にこの手法によって得られた
化合物フィルタリングスコアは化合物そのものの結合スコアよりも高くなり、特に分割数が多ければ多いほどこの傾向は顕著になる。
このため、重原子（水素以外の原子）の数が2個以下の小さなフラグメントの結合スコアはフィルタリングスコア算出から除外することで
フィルタリングスコアの無意味な向上を抑えている。
\todo{数式で表現}

\subsubsection{最良値法（score\_max）}
フラグメント結合スコアの最良値をとり、それを化合物のフィルタリングスコアとする。
構成するフラグメントの内、１つでもタンパク質と非常に良い結合構造をとれるような化合物が薬物候補化合物として適している、として
評価を高くする手法である。フラグメント１つの結合スコアが化合物のフィルタリングスコアとなること、ドッキングシミュレーションを行う分子のサイズと
結合スコアには正の相関がある\cite{Verdonk2004}ことから、総和法とは異なりこの手法によって得られた化合物フィルタリングスコアは
化合物そのものの結合スコアよりも低くなる。
\todo{数式で表現}

\subsubsection{総和法と最良値法の値の線形和（maxsumBS）}
これまでに示した総和法と最良値法はフラグメント結合スコアの全て、もしくはただ一つを見る手法であり両極端であるため、
これらを統合して用いることで、より良い指標となるのではないかと考えた。
しかし、総和法の値域が最良値法の値域よりも大きいために単純和では総和法の影響を大きく受けてしまう。
そこで、二つの手法を適当なバランスで組み合わせるために、フィルタリングを行いたい化合物の総和法によるスコア、最良値法によるスコアを
それぞれ平均0、分散1にし（すなわちzスコア化し）、変換後のスコアを足し合わせることでバランスよくスコアを統合することを試みた（図\ref{fig:maxsumBS}）。この手法は総和法によるスコアと最良値法によるスコアのバランスをとったスコアであるので、maxsumBS（max-sum Balanced Score）として以下記述する。
\begin{figure}[b]
 \begin{center}
  \fig[width=0.99\hsize]{./fig/method/maxsumBS.eps}
  \caption{maxsumBSの算出}
  \label{fig:maxsumBS}
 \end{center}
\end{figure}