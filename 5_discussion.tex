\chapter{考察}

\section{総和法におけるフラグメント数に対するペナルティ}\label{sec:discussion_penalty}
もし，フラグメントの結合スコアを単純に全て加算し，それを化合物のフィルタリングスコアとすると，図\ref{fig:no_omit_score_graph}のように
化合物の総原子数が同じであっても分割数が多いほどフィルタリングスコアが向上してしまう．これは計算手法によって発生してしまった誤った傾向である．
この分割数と総和法のスコアとの相関は最適化問題の条件緩和と考えることで説明できる．すなわち，本来化合物には原子間の結合距離という拘束条件が存在している．
フラグメント分割によって切断された原子間の結合は距離を考えずにスコア付けして良いので，分割は原子間の結合という拘束条件を
1つずつ緩和することに対応する．このため，フラグメント分割がされればされるほどスコアが良くなってしまうのである．
\begin{figure}[b]
 \begin{center}
  \fig[width=0.56\hsize]{./fig/discussion/no_omit_score.eps}
  \caption{ターゲットfntaの全ての化合物のうち重原子数32の化合物の単純加算スコア}
  \label{fig:no_omit_score_graph}
 \end{center}
\end{figure}

このような現象を改善するための手法として，以下2つの実験を行った．
\begin{enumerate}
\item \b{小さなフラグメントの無視}\\ 
	重原子（水素以外の原子）の個数に閾値を設け，その閾値を超えているフラグメントの結合スコアのみを
	総和に用いる．分割が多ければ多いほど小さなフラグメントが発生するため，
	小さなフラグメントの結合スコアを無視することで事実上のフラグメント数に対するペナルティとなる．
\item \b{フラグメント数に対する線形ペナルティ}\\
	全てのフラグメントの結合スコアを加算した後，化合物が持つフラグメントの個数に応じたペナルティを付与する．
	図\ref{fig:no_omit_score_graph}を見ると，フィルタリングスコアの平均とフラグメント数との関係は線形に近く，
	フラグメント数に対して線形なペナルティを課すことでフラグメント数に依存しないフィルタリングスコアとなることが想定される．
\end{enumerate}

この2つの手法を個別に利用した場合の総和法（score\_sum）の精度は表\ref{table:omit}および表\ref{table:penalty}のようになり，
重原子数3以下のフラグメントの結合スコアを無視することが最も精度を高めている．

\begin{table}[h] \centering
	\caption{小さなフラグメントを無視することによるscore\_sumの精度の変化}
	\label{table:omit}
	\begin{tabular}{c|rrrrr}
	\hline
	\multirow{2}{*}{無視するフラグメントのサイズ}	&\multirow{2}{*}{ROC-AUC}	&\multicolumn{4}{c}{Enrichment Factor}				\\
										&						&EF(1\%)		&EF(2\%)		&EF(5\%)		&EF(10\%)	\\ \hline
	全てのフラグメントを利用					&0.545					&3.46		&2.76		&2.01		&1.63		\\
	重原子数1							&0.557					&2.38		&2.16		&1.85		&1.66		\\
	重原子数2以下						&0.624					&5.08		&4.14		&3.02		&2.34		\\
	重原子数3以下						&{\bf 0.634}				&{\bf 5.75}	&{\bf 4.34}	&{\bf 3.03}	&{\bf 2.49}	\\
	重原子数4以下						&0.620					&4.27		&3.43		&2.79		&2.32		\\
	重原子数5以下						&0.614					&4.43		&3.68		&2.75		&2.13		\\
	重原子数6以下						&0.537					&2.20		&1.86		&1.53		&1.43		\\ \hline
	\end{tabular}
\end{table}
\begin{table}[h] \centering
	\caption{フラグメント数に対する線形ペナルティによるscore\_sumの精度の変化}
	\label{table:penalty}
	\begin{tabular}{c|rrrrr}
	\hline
	フラグメント1つあたりの	&\multirow{2}{*}{ROC-AUC}	&\multicolumn{4}{c}{Enrichment Factor}				\\
	ペナルティ$c$			&						&EF(1\%)		&EF(2\%)		&EF(5\%)		&EF(10\%)	\\ \hline
	ペナルティなし			&0.545					&3.46		&2.76		&2.01		&1.63		\\
	$c=1$				&0.559					&3.81		&2.98		&2.18		&1.77		\\
	$c=2$				&0.586					&4.70		&3.65		&2.66		&2.08		\\
	$c=3$				&{\bf 0.622}				&{\bf 5.03}	&{\bf 4.03}	&{\bf 2.86}	&{\bf 2.32}	\\
	$c=4$				&0.588					&3.80		&3.19		&2.51		&2.14		\\
	$c=5$				&0.549					&3.57		&2.96		&2.20		&1.78		\\
	$c=6$				&0.530					&3.30		&2.53		&1.91		&1.57		\\
	$c=7$				&0.520					&3.06		&2.29		&1.72		&1.46		\\ \hline
	\end{tabular}
\end{table}

\newpage

一方，同様に総和法のペナルティを変化させながら総和法と最良値法の線形和（maxsumBS）の精度について実験を行うと，
重原子数2以下のフラグメントの結合スコアを無視した総和法を用いた場合に最良のROC-AUCとなった（表\ref{table:omit_maxsumBS}，
表\ref{table:penalty_maxsumBS}）．
maxsumBSの精度はscore\_sumよりも良いことから，本研究の提案手法では重原子数2以下のフラグメントの結合スコアを無視した
総和法を利用する．
\begin{table}[hb] \centering
	\caption{小さなフラグメントを無視することによるmaxsumBSの精度の変化}
	\label{table:omit_maxsumBS}
	\begin{tabular}{c|rrrrr}
	\hline
	\multirow{2}{*}{無視するフラグメントのサイズ}	&\multirow{2}{*}{ROC-AUC}	&\multicolumn{4}{c}{Enrichment Factor}				\\
										&						&EF(1\%)		&EF(2\%)		&EF(5\%)		&EF(10\%)	\\ \hline
	全てのフラグメントを利用					&0.652					&5.35		&4.56		&3.32		&2.60		\\
	重原子数1							&0.652					&4.67		&4.18		&3.25		&2.56		\\
	重原子数2以下						&\b{0.679}				&\b{6.03}		&\b{5.03}		&\b{3.96}		&\b{3.00}		\\
	重原子数3以下						&0.672					&5.57		&4.79		&3.78		&2.85		\\
	重原子数4以下						&0.653					&4.89		&4.32		&3.46		&2.67		\\
	重原子数5以下						&0.643					&4.95		&4.28		&3.29		&2.55		\\
	重原子数6以下						&0.566					&2.76		&2.46		&2.03		&1.79		\\ \hline
	\end{tabular}
\end{table}
\begin{table}[hb] \centering
	\caption{フラグメント数に対する線形ペナルティによるmaxsumBSの精度の変化}
	\label{table:penalty_maxsumBS}
	\begin{tabular}{c|rrrrr}
	\hline
	フラグメント1つあたりの	&\multirow{2}{*}{ROC-AUC}	&\multicolumn{4}{c}{Enrichment Factor}				\\
	ペナルティ$c$			&						&EF(1\%)		&EF(2\%)		&EF(5\%)		&EF(10\%)	\\ \hline
	ペナルティなし			&0.652					&5.35		&4.56		&3.32		&2.60		\\
	$c=1$				&0.657					&5.67		&4.78		&3.40		&2.67		\\
	$c=2$				&\b{0.665}				&6.40		&\b{5.02}		&3.59		&2.80		\\
	$c=3$				&\b{0.665}				&5.97		&4.84		&\b{3.78}		&\b{2.88}		\\
	$c=4$				&0.630					&6.16		&4.69		&3.41		&2.66		\\
	$c=5$				&0.609					&\b{6.49}		&4.71		&3.17		&2.45		\\
	$c=6$				&0.600					&\b{6.49}		&4.69		&3.11		&2.36		\\
	$c=7$				&0.591					&6.43		&4.62		&3.06		&2.32		\\ \hline
	\end{tabular}
\end{table}

\newpage

\section{提案手法が得意とするケースの調査}
\ref{subsec:single_accuracy}節の実験結果より，提案手法は簡易なドッキングシミュレーションであるGlide HTVSモード
と比べて精度が低調に終わることが判明している．
しかし，本研究で用いた102ターゲット中46ターゲットに関しては提案手法が従来手法であるGlide HTVSモードよりも精度が良く，
ROC-AUCで0.2以上上回っているケースも表\ref{table:target_accuracy_good}に示す通り3例存在している．

どのような場合において提案手法が有用であるかを調べるため，この3つのターゲットについて
化合物の持つフラグメント数の平均，小さなフラグメントを削減した後のフラグメント数の平均，
sitemap\cite{Halgren2009}によって計算された各タンパク質の結合部位のサイズを求めた．
その結果，結合部位のサイズやデータセット全体を通してのフラグメント数などに傾向は見受けられなかったが，
\begin{itemize}
\item 化合物の持つフラグメント数の平均
\item 重原子数が2以下のフラグメント数の平均
\end{itemize}
どちらも正例より負例が上回っているということが判明した（表\ref{table:good_property}）．

\begin{table}[hb] \centering
	\caption{提案手法が上手く行ったケース}
	\label{table:target_accuracy_good}
	提案手法（maxsumBS）が従来手法（Glide HTVSモード）よりもROC-AUCで\\
	0.2以上上回ったケースについて，ROC-AUCの差の降順で示している．
	\begin{tabular}{c|r|rr}
	\hline
	\multirow{2}{*}{ターゲット名}	&\multirow{2}{*}{ROC-AUC差}	&\multicolumn{2}{c}{ROC-AUC}	\\
							&							&従来手法	&提案手法		\\ \hline
	mcr					&0.319						&0.466		&{\bf 0.785}		\\
	akt1					&0.285						&0.539		&{\bf 0.824}		\\
	gcr						&0.252						&0.528		&{\bf 0.780}		\\ \hline
	\end{tabular}
\end{table}
\begin{table}[htb] \centering
	\caption{提案手法が得意なターゲットの性質}
	\label{table:good_property}
	\begin{tabular}{c|rrrrrrr}
	\hline
	\multirow{2}{*}{ターゲット}	&\multicolumn{3}{c}{\multirow{2}{*}{フラグメント数の平均}}	&\multicolumn{3}{c}{重原子数2以下の}		&\multirow{2}{*}{結合部位のサイズ [$\mathrm{\r{A}}^3$]}	\\
							&		&		&								&\multicolumn{3}{c}{フラグメント数の平均}	&										\\
							&全体	&正例	&負例							&全体	&正例		&負例			&										\\ \hline
	akt1						&7.98	&6.94	&8.00							&4.64	&3.08		&4.66			&637									\\
	gcr						&5.93	&5.33	&5.94							&2.68	&2.00		&2.69			&471									\\
	mcr						&5.90	&5.43	&5.91							&2.67	&2.06		&2.68			&179									\\ \hline
	全102ターゲット平均		&7.22	&7.43	&7.21							&3.83	&3.78		&3.83			&437									\\ \hline
	\end{tabular}
\end{table}

\newpage

例えば，ホルモテロール（図\ref{fig:drugs}-(a)）とカンデサルタン（図\ref{fig:drugs}-(b)）はそれぞれ薬剤として
認められている化合物だが，重原子数が2以下になるフラグメントの量がかなり異なる．
このような場合，
前者(a)のような重原子数2以下のフラグメントが多く発生してしまう化合物が結合するタンパク質を
対象としたフィルタリングには従来通り簡易ドッキングシミュレーションを用い，
後者(b)のような重原子数2以下のフラグメントがあまり発生しない化合物が結合するタンパク質を
対象としたフィルタリングには提案手法を用いることで
より高い精度でフィルタリングを行うことができると推定される．

一方この性質は\ref{sec:discussion_penalty}節で示したペナルティの影響を受けていると考えられるため，
化合物の構造の有利不利が発生しないようなスコア計算手法およびペナルティの考案を引き続き行う必要がある．

\begin{figure}[t]
 \begin{center}
  \fig[width=0.85\hsize]{./fig/discussion/drugs_decomposition.eps}
 \end{center}
  \caption{薬剤化合物の例：(a)ホルモテロール， (b)カンデサルタン}
  \label{fig:drugs}
\end{figure}


\section{提案手法の利用例}
バーチャルスクリーニングでは数百万化合物から数百化合物程度を選別することが多く，
上位0.01\%など，非常に小さな比率におけるEnrichment Factorの計算などが本来必要となる．
また，計算時間に関しても数百万化合物を用いた場合に何日を要するのか，という評価が必要である．

しかし本研究で評価に利用したデータセットであるDUD-Eは表\ref{table:dude}で示したように472化合物しか存在しないターゲットも存在しており，このようなターゲットは上位0.01\%を計算することは不可能である．
そこで，ここではDUD-Eのターゲットのうち総化合物数が10,000以上である49ターゲットを用いることで，フィルタリングにおける化合物の通過率がより少ない場合や，
EF (0.1\%)などの小さな割合におけるEFの評価（表\ref{table:usecase_accuracy}）を用い，実際のバーチャルスクリーニングでの提案手法の利用例を示す．
計算速度に関しては線形に計算量が増大すると仮定することで数百万化合物を評価した場合の計算時間を見積もる．

なお，総化合物数が10,000以上である49ターゲットの平均化合物数は22,259, 平均フラグメント種類数は4,588である．

\begin{enumerate}
\item \b{超高速な化合物全体の評価}\\
	表\ref{table:usecase_accuracy}によると，提案手法で0.5\%の化合物をフィルタリングし，それらを通常のドッキングシミュレーションで再評価
	することでGlide HTVSモードを用いる場合の約8分の1の計算時間で評価を完了させることができる．例えば1,000万化合物を評価する場合，
	今回のケースの450倍程度の化合物数となるので，Glide HTVSモードは1 CPU換算で4か月程度を要してしまう．
	一方，提案手法と通常ドッキングであるGlide SPモードの組み合わせでは1 CPUでも半月程度で済む計算となる．この差は大きく，
	提案手法は有用であると言える．
\begin{table}[htbp] \centering
	\caption{化合物全体を評価するのに要する時間の比較}
	\label{calc_speed_ultrafast}
	\begin{tabular}{l|rr}
	\hline
												&合計計算時間	&1,000万化合物評価の		\\ 
												&[CPU sec.]		&推定時間 [CPU days]		\\ \hline
	提案手法で0.5\%フィルタリング	&3,280				&17.1								\\
	Glide HTVSモード単独性能		&23,552				&122.5								\\ \hline
	\end{tabular}
\end{table}
\item \b{従来手法以下の所要時間の中での予測精度の向上}\\
	表\ref{table:usecase_accuracy}に示されている通り，提案手法と従来手法とで単純に比較を行うと精度は従来手法に分がある．
	しかしいくつかのケースについては，化合物ライブラリのサイズを変えることで同程度の所要時間の中で精度を高めることができる．
	例えば，100万化合物をGlide HTVSモードを用いて10\%にフィルタリングし，Glide SPでリランキングした場合，上位1万化合物の濃縮率(EF 1\%に相当する)は16.89，この時の推定必要計算時間は32.0 CPU daysとなる．
	一方，1,000万化合物を提案手法で1\%にフィルタリングし，Glide SPでリランキングした場合，上位1万化合物の濃縮率(EF 0.1\%に相当する)は20.26，この時の推定必要計算時間は26.9 CPU daysとなり，
	速度を向上させつつ，予測精度を高めることができる．このようなケースは複数存在しており（表\ref{table:win_proposal_case}），これらの場合においては提案手法を利用すべきであると言える．
\end{enumerate}


\begin{landscape}
\begin{table}[p] \centering
	\caption{総化合物数が1万以上存在するDUD-Eのターゲットに対する評価実験}
	\label{table:usecase_accuracy}
	\begin{tabular}{lc|rrrrr|r}
	\hline
	\multicolumn{2}{c|}{フィルタリング}					&\multirow{2}{*}{EF（0.1\%）}	&\multirow{2}{*}{EF（0.2\%）}	&\multirow{2}{*}{EF（0.5\%）}	&\multirow{2}{*}{EF（1\%）}	&\multirow{2}{*}{EF（2\%）}	&合計計算時間	\\
	\multicolumn{1}{c}{手法}	&通過率					&						&						&						&						&						&[CPU sec.]		\\ \hline
	提案手法（maxsumBS）		&\multirow{2}{*}{0.5\%}	&14.33					&9.39					&\textendash				&\textendash				&\textendash				&3,280			\\
	従来手法（Glide HTVSモード）	&					&35.16					&29.97					&\textendash				&\textendash				&\textendash				&25,452			\\
	提案手法（maxsumBS）		&\multirow{2}{*}{1\%}	&20.26					&13.91					&7.14					&\textendash				&\textendash				&5,180			\\
	従来手法（Glide HTVSモード）	&					&35.36					&31.17					&22.19					&\textendash				&\textendash				&27,352			\\
	提案手法（maxsumBS）		&\multirow{2}{*}{2\%}	&24.87					&19.14					&10.57					&6.32					&\textendash				&8,979			\\
	従来手法（Glide HTVSモード）	&					&35.54					&31.69					&23.10					&15.50					&\textendash				&31,151			\\
	提案手法（maxsumBS）		&\multirow{2}{*}{5\%}	&29.24					&25.04					&16.80					&10.51					&6.29					&20,378			\\
	従来手法（Glide HTVSモード）	&					&35.54					&31.40					&23.56					&16.28					&10.59					&42,550			\\
	提案手法（maxsumBS）		&\multirow{2}{*}{10\%}	&31.94					&27.48					&19.68					&13.58					&8.36					&39,377			\\
	従来手法（Glide HTVSモード）	&					&35.70					&31.78					&23.80					&16.89					&11.07					&61,549			\\ \hline
	\multicolumn{2}{l|}{通常ドッキング（Glide SPモード）}	&35.98					&32.82					&25.57					&18.96					&12.82					&379,965			\\ \hline
	\end{tabular}
\end{table}
\end{landscape}

\begin{table}[p] \centering
	\caption{提案手法が従来手法に速度・精度ともに勝る例}
	\label{table:win_proposal_case}
	\begin{tabular}{l|rrr}
	\hline
												&\multirow{2}{*}{化合物数}	&上位1万化合物の		&推定計算時間	\\
												&														&濃縮率(EF)				&[CPU days]		\\ \hline
	提案手法で1\%フィルタリング		&1,000万											&20.26 (EF 0.1\%)		&26.9				\\
	Glide HTVSモードで10\%フィルタリング	&100万												&16.89 (EF 1\%)			&32.0				\\ \hline
	提案手法で1\%フィルタリング		&500万												&13.91 (EF 0.2\%)		&13.5				\\
	Glide HTVSモードで10\%フィルタリング	&50万												&11.07 (EF 2\%)			&16.0				\\ \hline
	提案手法で2\%フィルタリング		&1,000万											&24.87 (EF 0.1\%)		&46.7				\\
	Glide HTVSモードで10\%フィルタリング	&200万												&23.80 (EF 0.5\%)		&64.0				\\ \hline
	提案手法で5\%フィルタリング		&200万												&16.80 (EF 0.5\%)		&21.2				\\
	Glide HTVSモードで5\%フィルタリング		&100万												&16.28 (EF 1\%)			&22.1				\\ \hline
	

	\end{tabular}
\end{table}
	
